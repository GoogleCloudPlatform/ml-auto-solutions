# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Utilities to construct configs for TensorRT-LLM inference DAG."""

import datetime
from dags.common import test_owner
from xlml.apis import gcp_config, metric_config, task, test_config
from dags.common import vm_resource
from dags.common.vm_resource import Project, RuntimeVersion

RUNTIME_IMAGE = RuntimeVersion.TPU_UBUNTU2204_BASE.value
GCS_SUBFOLDER_PREFIX = test_owner.Team.INFERENCE.value


def get_maxtext_gpu_inference_config(
    machine_type: vm_resource.MachineVersion,
    image_project: vm_resource.ImageProject,
    image_family: vm_resource.ImageFamily,
    accelerator_type: vm_resource.GpuVersion,
    count: int,
    gpu_zone: vm_resource.Zone,
    time_out_in_min: int,
    test_name: str,
    project: Project,
    network: str,
    subnetwork: str,
    existing_instance_name: str = None,
) -> task.GpuCreateResourceTask:
  set_up_cmds = (
      "pip install --upgrade pip",
      # Pull maxtext container from Nvidia
      "docker pull ghcr.io/nvidia/jax:maxtext",
      "docker run -d --rm -it --net=host --shm-size=256g --gpus all -v /scratch:/scratch --name maxtext ghcr.io/nvidia/jax:maxtext sleep infinity",
  )

  jsonl_output_path = "metric_report.jsonl"
  docker_container_name = "maxtext"
  local_output_dir = "/opt/maxtext/"
  docker_cmds = (
      "pip install jsonlines",
      "git checkout -- .",
      "git checkout main",
      "git pull",
      # patch cl/733390414
      "rm /usr/local/lib/python3.12/dist-packages/aqt/jax/v2/flax/aqt_flax.py",
      "printf 'CiMgQ29weXJpZ2h0IDIwMjIgR29vZ2xlIExMQwojCiMgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiMgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgojIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAojCiMgICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKIwojIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKIyBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAojIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgojIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKIyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KIiIiRmxheCBsYXllciBmb3IgQVFUIGluamVjdGlvbi4iIiIKIyBweWxpbnQ6IGRpc2FibGU9dW5uZWNlc3NhcnktbGFtYmRhCiMgcHlsaW50OiBkaXNhYmxlPWctaW1wb3J0aW5nLW1lbWJlcgppbXBvcnQgY29weQppbXBvcnQgZW51bQppbXBvcnQgZnVuY3Rvb2xzCmZyb20gdHlwaW5nIGltcG9ydCBDYWxsYWJsZSwgSXRlcmFibGUsIFNlcXVlbmNlCmZyb20gYXF0LmpheC52MiBpbXBvcnQgYXF0X2NvbnZfZ2VuZXJhbApmcm9tIGFxdC5qYXgudjIgaW1wb3J0IGFxdF9kb3RfZ2VuZXJhbApmcm9tIGFxdC5qYXgudjIgaW1wb3J0IGFxdF90ZW5zb3IKZnJvbSBhcXQuamF4LnYyIGltcG9ydCBjb25maWcKZnJvbSBhcXQuamF4LnYyIGltcG9ydCB0aWxlZF9kb3RfZ2VuZXJhbApmcm9tIGFxdC5qYXgudjIgaW1wb3J0IHRyYW5zcG9zZQpmcm9tIGFxdC5qYXgudjIgaW1wb3J0IHV0aWxzCmZyb20gYXF0LmpheC52Mi5mbGF4IGltcG9ydCBhcXRfZmxheF9kZ19jb3JlCmZyb20gYXF0LmpheC52Mi5mbGF4IGltcG9ydCBmcmVlemVyIGFzIGdlbmVyYWxfZnJlZXplcgpmcm9tIGFxdC5qYXgudjIudXRpbHMgaW1wb3J0IFF1YW50TW9kZQppbXBvcnQgZmxheC5jb3JlLm1ldGEgYXMgbm5fbWV0YQppbXBvcnQgZmxheC5saW5lbiBhcyBubgppbXBvcnQgamF4CmltcG9ydCBqYXgubnVtcHkgYXMgam5wCk5vU2hhcmRpbmdBeGVzID0gU2VxdWVuY2VbdXRpbHMuQXhpc0lkeF0KQXhpc01ldGFkYXRhV3JhcHBlciA9IENhbGxhYmxlWwogICAgW2pucC5uZGFycmF5LCBOb25lIHwgdGlsZWRfZG90X2dlbmVyYWwuQXF0VGlsZU1hcCwgTm9TaGFyZGluZ0F4ZXNdLAogICAgbm5fbWV0YS5BeGlzTWV0YWRhdGEsCl0KRG90R2VuZXJhbFRpbGluZ0ZuID0gQ2FsbGFibGVbCiAgICBbam5wLm5kYXJyYXksIGpucC5uZGFycmF5LCBqYXgubGF4LkRvdERpbWVuc2lvbk51bWJlcnNdLAogICAgdGlsZWRfZG90X2dlbmVyYWwuQ2ZnCl0KRWluc3VtVGlsaW5nRm4gPSBDYWxsYWJsZVsKICAgIFt0aWxlZF9kb3RfZ2VuZXJhbC5FaW5zdW1FcW5MZXR0ZXIsIGpucC5uZGFycmF5LCBqbnAubmRhcnJheV0sCiAgICB0aWxlZF9kb3RfZ2VuZXJhbC5DZmcKXQpfUVVBTlRfVE9fRlJFRVpFUl9NT0RFID0gewogICAgUXVhbnRNb2RlLlRSQUlOOiBnZW5lcmFsX2ZyZWV6ZXIuRnJlZXplck1vZGUuTk9ORSwKICAgIFF1YW50TW9kZS5DQUxJQlJBVEU6IGdlbmVyYWxfZnJlZXplci5GcmVlemVyTW9kZS5OT05FLAogICAgUXVhbnRNb2RlLkNPTlZFUlQ6IGdlbmVyYWxfZnJlZXplci5GcmVlemVyTW9kZS5XUklURSwKICAgIFF1YW50TW9kZS5TRVJWRTogZ2VuZXJhbF9mcmVlemVyLkZyZWV6ZXJNb2RlLlJFQUQsCn0KZGVmIF9mcmVlemVyX3F0ZW5zb3JfaW5pdF93cmFwcGVyKAogICAgcXQ6IGFxdF90ZW5zb3IuUVRlbnNvciwKICAgIGNvbnRyYWN0aW5nX2F4aXM6IFNlcXVlbmNlW3V0aWxzLkF4aXNJZHhdLAogICAgYXhpc19tZXRhZGF0YV93cmFwcGVyOiBOb25lIHwgQXhpc01ldGFkYXRhV3JhcHBlciwKICAgIHRpbGVfbWFwOiB0aWxlZF9kb3RfZ2VuZXJhbC5BcXRUaWxlTWFwLAopOgogICIiIlFUZW5zb3IgaW5pdGlhbGl6YXRpb24gd3JhcHBlciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBmcmVlemVyLiIiIgogICMgQ29weSB0byBhdm9pZCBtdXRhdGluZyB0aGUgaW5wdXQgUVRlbnNvciBoZXJlIG9yIGRvd25zdHJlYW0gKHJlZ2FyZGxlc3Mgb2YKICAjIGF4aXNfbWV0YWRhdGFfd3JhcHBlcidzIHZhbHVlKS4KICBxdCA9IGNvcHkuZGVlcGNvcHkocXQpCiAgaWYgYXhpc19tZXRhZGF0YV93cmFwcGVyIGlzIE5vbmU6CiAgICByZXR1cm4gcXQKICBzY2FsZV9ub25fc2hhcmRfYXhpc19hbGwgPSBsaXN0KHJhbmdlKHF0Lm5kaW0pKQogIHNjYWxlX25vbl9zaGFyZF9heGlzX2NvbnRyYWN0aW5nID0gbGlzdChjb250cmFjdGluZ19heGlzKQogIGRlZiBfZ2V0X3NpbmdsZXRvbl9heGVzKHg6IGpucC5uZGFycmF5KSAtPiBsaXN0W3V0aWxzLkF4aXNJZHhdOgogICAgcmV0dXJuIFtheGlzIGZvciBheGlzLCBkaW0gaW4gZW51bWVyYXRlKHguc2hhcGUpIGlmIGRpbSA9PSAxXQogIHF0LnF2YWx1ZSA9IGF4aXNfbWV0YWRhdGFfd3JhcHBlcihxdC5xdmFsdWUsIHRpbGVfbWFwLCBbXSkKICBxdC5zY2FsZSA9IGpheC50cmVlLm1hcCgKICAgICAgbGFtYmRhIHg6IGF4aXNfbWV0YWRhdGFfd3JhcHBlcigKICAgICAgICAgIHgsIHRpbGVfbWFwLCBzY2FsZV9ub25fc2hhcmRfYXhpc19jb250cmFjdGluZwogICAgICApLAogICAgICBxdC5zY2FsZSwKICApCiAgIyBQYXNzaW5nIHNjYWxlX25vbl9zaGFyZF9heGlzX2NvbnRyYWN0aW5nIHdvdWxkIGJlIGluY29ycmVjdCBkdWUgdG8KICAjIHNjYWxlIHRyYW5zcG9zaXRpb24uIHNjYWxlX3QgaXMgYmVpbmcgcmVtb3ZlZCBmcm9tIFFUZW5zb3IgYW55d2F5CiAgIyBzbyB3ZSBqdXN0IHBhc3Mgc2NhbGVfbm9uX3NoYXJkX2F4aXNfYWxsLgogIHF0LnNjYWxlX3QgPSBqYXgudHJlZS5tYXAoCiAgICAgIGxhbWJkYSB4OiBheGlzX21ldGFkYXRhX3dyYXBwZXIoeCwgdGlsZV9tYXAsIHNjYWxlX25vbl9zaGFyZF9heGlzX2FsbCksCiAgICAgIHF0LnNjYWxlX3QsCiAgKQogICMgU2V0IHRoZSBub24tc2hhcmRpbmcgYXhlcyBmb3IgYmlhcyB0byB0aGUgc2luZ2xldG9uIGRpbWVuc2lvbnMuCiAgcXQuYmlhcyA9IGpheC50cmVlLm1hcCgKICAgICAgbGFtYmRhIHg6IGF4aXNfbWV0YWRhdGFfd3JhcHBlcih4LCB0aWxlX21hcCwgX2dldF9zaW5nbGV0b25fYXhlcyh4KSksCiAgICAgIHF0LmJpYXMsCiAgKQogIHJldHVybiBxdApkZWYgYXF0X3Byb21vdGVfZHR5cGUoCiAgICBsaHNfaW46IGpucC5uZGFycmF5LCByaHNfaW46IGpucC5uZGFycmF5CikgLT4gdHVwbGVbam5wLm5kYXJyYXksIGpucC5uZGFycmF5XToKICAiIiJQcm9tb3RlcyB0aGUgZHR5cGUgb2YgbGhzX2luIGFuZCByaHNfaW4uCiAgQXJnczoKICAgIGxoc19pbjogTGVmdC1oYW5kLXNpZGUgYXJyYXkuCiAgICByaHNfaW46IFJpZ2h0LWhhbmQtc2lkZSBhcnJheS4KICBSZXR1cm5zOgogICAgQSB0dXBsZSBvZiB0aGUgcHJvbW90ZWQgbGhzX2luIGFuZCByaHNfaW4uCiAgV2UgY3JlYXRlIGEgbGlzdCBvZiBkdHlwZXMgYW5kIGhhbmQtaG9sZCB0aGVtIGJlY2F1c2UgcHJvbW90ZV9kdHlwZSBmYWlscyBmb3IKICB0aGVzZSBkdHlwZXMuCiAgIiIiCiAgbWFudWFsX3Byb21vdGlvbl9kdHlwZXMgPSBbam5wLmludDQsIGpucC5mbG9hdDhfZTRtM2ZuLCBqbnAuZmxvYXQ4X2U1bTJdCiAgaWYgKAogICAgICBsaHNfaW4uZHR5cGUgaW4gbWFudWFsX3Byb21vdGlvbl9kdHlwZXMKICAgICAgYW5kIHJoc19pbi5kdHlwZSBpbiBtYW51YWxfcHJvbW90aW9uX2R0eXBlcwogICk6CiAgICBpZiBsaHNfaW4uZHR5cGUgPT0gcmhzX2luLmR0eXBlOgogICAgICBwYXNzCiAgICBlbHNlOgogICAgICBsaHNfaW4gPSAoCiAgICAgICAgICBqbnAuZmxvYXQzMihsaHNfaW4pCiAgICAgICAgICBpZiBsaHNfaW4uZHR5cGUgPT0gam5wLmludDQKICAgICAgICAgIGVsc2Ugam5wLmJmbG9hdDE2KGxoc19pbikKICAgICAgKQogICAgICByaHNfaW4gPSAoCiAgICAgICAgICBqbnAuZmxvYXQzMihyaHNfaW4pCiAgICAgICAgICBpZiByaHNfaW4uZHR5cGUgPT0gam5wLmludDQKICAgICAgICAgIGVsc2Ugam5wLmJmbG9hdDE2KHJoc19pbikKICAgICAgKQogIGVsaWYgbGhzX2luLmR0eXBlIGluIG1hbnVhbF9wcm9tb3Rpb25fZHR5cGVzOgogICAgbGhzX2luID0gKAogICAgICAgIGpucC5mbG9hdDMyKGxoc19pbikKICAgICAgICBpZiBsaHNfaW4uZHR5cGUgPT0gam5wLmludDQKICAgICAgICBlbHNlIGpucC5iZmxvYXQxNihsaHNfaW4pCiAgICApCiAgZWxpZiByaHNfaW4uZHR5cGUgaW4gbWFudWFsX3Byb21vdGlvbl9kdHlwZXM6CiAgICByaHNfaW4gPSAoCiAgICAgICAgam5wLmZsb2F0MzIocmhzX2luKQogICAgICAgIGlmIHJoc19pbi5kdHlwZSA9PSBqbnAuaW50NAogICAgICAgIGVsc2Ugam5wLmJmbG9hdDE2KHJoc19pbikKICAgICkKICBpZiAoCiAgICAgIGxoc19pbi5kdHlwZSBub3QgaW4gbWFudWFsX3Byb21vdGlvbl9kdHlwZXMKICAgICAgYW5kIHJoc19pbi5kdHlwZSBub3QgaW4gbWFudWFsX3Byb21vdGlvbl9kdHlwZXMKICApOgogICAgbGhzX2luLCByaHNfaW4gPSBubi5kdHlwZXMucHJvbW90ZV9kdHlwZShsaHNfaW4sIHJoc19pbikKICByZXR1cm4gbGhzX2luLCByaHNfaW4KY2xhc3MgRnJlZXplck1vZGUoZW51bS5FbnVtKToKICBOT05FID0gMQogIENBTElCUkFUSU9OID0gMgogIENBTElCUkFUSU9OX0FORF9WQUxVRSA9IDMKY2xhc3MgRnJlZXplcihubi5Nb2R1bGUpOgogICIiIklkZW50aXR5IGZ1bmN0aW9uIHRoYXQgY2FuIGZyZWV6ZSBpdHMgaW5wdXQuCiAgT24gZGVmYXVsdCBpdCBpcyBhbiBpZGVudGl0eSBmdW5jdGlvbiB0aGF0IHNhdmVzIHRoZSBpbnB1dCBpbiBhIHZhcmlhYmxlLgogIEluICdxdWFudF9tb2RlPVF1YW50TW9kZS5TZXJ2ZScgbW9kZSwgaWdub3JlcyB0aGUgaW5wdXQgYW5kIHJldHVybnMgdGhlIGZyb3plbgogIHZhbHVlLiBJdCBpcyB1c2VmdWwgdG8gaW1wbGVtZW50ICdjb25zdGFudCBmb2xkaW5nJyBhbmQgcHV0IHF1YW50aXplZCB3ZWlnaHRzCiAgYW5kIHNjYWxlcyBpbiB0aGUgY2hlY2twb2ludCBmb3Igc2VydmluZy4gU3BlY2lmaWNhbGx5OgogIHNlbGYuZ2V0KCkgcmV0dXJucyBOb25lIHdoZW4gcXVhbnRfbW9kZT1UUkFJTiBvciBDT05WRVJULCByZXR1cm5zIHZhcmlhYmxlCiAgd2hlbiBxdWFudF9tb2RlPVNFUlZFLgogIHNlbGYuc2V0KCkgZG9lcyBub3RoaW5nIHdoZW4gcXVhbnRfbW9kZT1UUkFJTiBvciBTRVJWRSwgY3JlYXRlcyBhbmQgc3RvcmVzCiAgcXVhbnRpemVkIHRlbnNvciB3aGVuIHF1YW50X21vZGU9Q09OVkVSVC4KICAiIiIKICBxdWFudF9jb2xsZWN0aW9uOiBzdHIKICBxdWFudF9tb2RlOiBRdWFudE1vZGUKICBxX3NoYXBlOiBJdGVyYWJsZVtpbnRdCiAgcV9kdHlwZTogam5wLmR0eXBlCiAgcV9pbml0OiBubi5pbml0aWFsaXplcnMuSW5pdGlhbGl6ZXIKICBzX3NoYXBlOiBJdGVyYWJsZVtpbnRdCiAgc19pbml0OiBubi5pbml0aWFsaXplcnMuSW5pdGlhbGl6ZXIKICBkZWYgc2V0dXAoc2VsZik6CiAgICBtb2RlID0gc2VsZi5xdWFudF9tb2RlCiAgICBpZiBtb2RlID09IFF1YW50TW9kZS5TRVJWRSBvciBtb2RlID09IFF1YW50TW9kZS5DT05WRVJUOgogICAgICBjb2xsZWN0aW9uID0gc2VsZi5xdWFudF9jb2xsZWN0aW9uCiAgICAgIHFfaW5pdCA9IHNlbGYucV9pbml0CiAgICAgIHFfc2hhcGUgPSBzZWxmLnFfc2hhcGUKICAgICAgcV9kdHlwZSA9IHNlbGYucV9kdHlwZQogICAgICBzX2luaXQgPSBzZWxmLnNfaW5pdAogICAgICBzX3NoYXBlID0gc2VsZi5zX3NoYXBlCiAgICAgICMgVE9ETyhsZXcpOiBTdG9yZSB3aG9sZSBRVGVuc29yPwogICAgICAjIFdlIGNvdWxkIGhhdmUgY3JlYXRlZCBvbmUgc2VsZi52YXJpYWJsZSB3aG9zZSB2YWx1ZSBpcyBhIFFUZW5zb3IsCiAgICAgICMgYnV0IHdlIGFyZSB1bnN1cmUgaG93IHRoaXMgd291bGQgY29tcGxpY2F0ZSB0aGUgaW5pdCBmdW5jdGlvbiwKICAgICAgIyB3aGljaCBjb3VsZCBwb3RlbnRpYWxseSBiZSB1c2VkIGJ5IGFkZGluZyBtZXRhZGF0YSBzdWNoIGFzCiAgICAgICMgc2hhcmRpbmcgYXhpc2VzLCBldGMuCiAgICAgIHNlbGYucXZhbHVlID0gc2VsZi52YXJpYWJsZShjb2xsZWN0aW9uLCAndmFsdWUnLCBxX2luaXQsIHFfc2hhcGUsIHFfZHR5cGUpCiAgICAgIHNlbGYuc2NhbGVfdCA9IHNlbGYudmFyaWFibGUoY29sbGVjdGlvbiwgJ3NjYWxlJywgc19pbml0LCBzX3NoYXBlKQogIGRlZiBnZXQoc2VsZikgLT4gTm9uZSB8IGFxdF90ZW5zb3IuUVRlbnNvcjoKICAgIGlmIHNlbGYucXVhbnRfbW9kZSA9PSBRdWFudE1vZGUuVFJBSU46CiAgICAgIHJldHVybiBOb25lCiAgICBlbGlmIHNlbGYucXVhbnRfbW9kZSA9PSBRdWFudE1vZGUuQ0FMSUJSQVRFOgogICAgICByZXR1cm4gTm9uZQogICAgZWxpZiBzZWxmLnF1YW50X21vZGUgPT0gUXVhbnRNb2RlLkNPTlZFUlQ6CiAgICAgIHJldHVybiBOb25lCiAgICBlbGlmIHNlbGYucXVhbnRfbW9kZSA9PSBRdWFudE1vZGUuU0VSVkU6CiAgICAgIHJldHVybiBhcXRfdGVuc29yLlFUZW5zb3IoCiAgICAgICAgICBxdmFsdWU9c2VsZi5xdmFsdWUudmFsdWUsCiAgICAgICAgICBzY2FsZT1Ob25lLAogICAgICAgICAgc2NhbGVfdD1bc2VsZi5zY2FsZV90LnZhbHVlXSwKICAgICAgICAgIGJpYXM9W10sCiAgICAgICAgICAjIFRPRE8obGV3KTogSWRlYWwgc29sdXRpb246IFRvIGZpbmQgb3V0IHRoaXMgZGVxdWFudF9kdHlwZSBvbmUgc2hvdWxkCiAgICAgICAgICAjIHVzZSB0aGUgZHR5cGUgb2YgaW5wdXRzIG9mIHRoZSBxdWFudCBmdW5jdGlvbi4gV2Ugc2hvdWxkIHN0b3JlIGl0IGFzCiAgICAgICAgICAjIGEgZHR5cGUgb2Ygc21hbGwtc2l6ZWQgc2NhbGUgdGVuc29yLgogICAgICAgICAgZGVxdWFudF9kdHlwZT1zZWxmLnNjYWxlX3QudmFsdWUuZHR5cGUsCiAgICAgICkKICAgIGVsc2U6CiAgICAgIGFzc2VydCBGYWxzZSwgJ1Vua25vd24gcXVhbnQgbW9kZS4nCiAgZGVmIHNldChzZWxmLCBpbnB1dHM6IGFxdF90ZW5zb3IuUVRlbnNvcikgLT4gTm9uZToKICAgICMgVE9ETyhiLzMyNTYyNjA4MCk6IFVuY29tbWVudGluZyB0aGUgYXNzZXJ0IHdpbGwgZmFpbC4KICAgICMgYXNzZXJ0IGlucHV0cy5xdmFsdWUuZHR5cGUgPT0gc2VsZi5xX2R0eXBlLCAoCiAgICAjICAgICBmJ0ZyZWV6ZXIgZ290IGEgUVRlbnNvciBvZiB0eXBlIHtpbnB1dHMucXZhbHVlLmR0eXBlfSBidXQgZXhwZWN0ZWQnCiAgICAjICAgICBmJyB7c2VsZi5xX2R0eXBlfS4nCiAgICAjICkKICAgIGlmIGlucHV0cy5iaWFzOgogICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yKAogICAgICAgICAgJ1F1YW50aXphdGlvbiBiaWFzZXMgYXJlIG5vdCBzdXBwb3J0ZWQgaW4gQVFUIEZsYXggTGVnYWN5IEZyZWV6ZXIuJwogICAgICApCiAgICBpZiBzZWxmLnF1YW50X21vZGUgPT0gUXVhbnRNb2RlLlRSQUlOOgogICAgICBwYXNzCiAgICBlbGlmIHNlbGYucXVhbnRfbW9kZSA9PSBRdWFudE1vZGUuQ0FMSUJSQVRFOgogICAgICBwYXNzCiAgICBlbGlmIHNlbGYucXVhbnRfbW9kZSA9PSBRdWFudE1vZGUuQ09OVkVSVDoKICAgICAgc2VsZi5xdmFsdWUudmFsdWUgPSBpbnB1dHMucXZhbHVlCiAgICAgIGFzc2VydCBpbnB1dHMuc2NhbGVfdCBpcyBub3QgTm9uZSBhbmQgbGVuKGlucHV0cy5zY2FsZV90KSA9PSAxCiAgICAgIHNlbGYuc2NhbGVfdC52YWx1ZSA9IGlucHV0cy5zY2FsZV90WzBdCiAgICBlbGlmIHNlbGYucXVhbnRfbW9kZSA9PSBRdWFudE1vZGUuU0VSVkU6CiAgICAgICMgVE9ETyhsZXcpOiBPcHRpb25hbGx5IGNvbXBhcmUgc3RvcmVkIGFuZCBzZXJ2ZWQgdmFsdWUuCiAgICAgIHBhc3MKICAgIGVsc2U6CiAgICAgIGFzc2VydCBGYWxzZSwgJ1Vua25vd24gcXVhbnQgbW9kZS4nCiAgICByZXR1cm4gTm9uZQpkZWYgX21heWJlX3JlY292ZXJfc2NhbGVfZnJvbV9zY2FsZV90KAogICAgcXQ6IE5vbmUgfCBhcXRfdGVuc29yLlFUZW5zb3IsCiAgICBkaW1lbnNpb25fbnVtYmVyczogamF4LmxheC5Eb3REaW1lbnNpb25OdW1iZXJzLAogICAgaXNfcmhzOiBib29sLAogICAgbGhzX3NoYXBlOiBTZXF1ZW5jZVtpbnRdLAogICAgcmhzX3NoYXBlOiBTZXF1ZW5jZVtpbnRdLAopIC0+IGFxdF90ZW5zb3IuUVRlbnNvcjoKICAiIiJSZWNvdmVycyBzY2FsZSBmcm9tIHNjYWxlX3QgaWYgbmVjZXNzYXJ5LiIiIgogIGlmIHF0IGlzIE5vbmUgb3IgcXQuc2NhbGUgaXMgbm90IE5vbmUgb3IgcXQuc2NhbGVfdCBpcyBOb25lOgogICAgcmV0dXJuIHF0CiAgdHJhbnNwb3NlX2ZuID0gdHJhbnNwb3NlLmxoc19yZWNvdmVyX3NjYWxlX2Zyb21fc2NhbGVfdAogIGlmIGlzX3JoczoKICAgIHRyYW5zcG9zZV9mbiA9IHRyYW5zcG9zZS5yaHNfcmVjb3Zlcl9zY2FsZV9mcm9tX3NjYWxlX3QKICBxdC5zY2FsZSA9IFsKICAgICAgdHJhbnNwb3NlX2ZuKHNjYWxlX3QsIGRpbWVuc2lvbl9udW1iZXJzLCBsaHNfc2hhcGUsIHJoc19zaGFwZSkKICAgICAgZm9yIHNjYWxlX3QgaW4gcXQuc2NhbGVfdAogIF0KICBxdC5zY2FsZV90ID0gTm9uZQogIHJldHVybiBxdApkZWYgX3BvcHVsYXRlX3NjYWxlX3QoCiAgICBxdDogYXF0X3RlbnNvci5RVGVuc29yLAogICAgZGltZW5zaW9uX251bWJlcnM6IGpheC5sYXguRG90RGltZW5zaW9uTnVtYmVycywKICAgIGlzX3JoczogYm9vbCwKICAgIGxoc19zaGFwZTogU2VxdWVuY2VbaW50XSwKICAgIHJoc19zaGFwZTogU2VxdWVuY2VbaW50XSwKKSAtPiBhcXRfdGVuc29yLlFUZW5zb3I6CiAgIiIiUG9wdWxhdGVzIHNjYWxlX3QgZnJvbSBzY2FsZS4iIiIKICBpZiBxdC5zY2FsZSBpcyBOb25lOgogICAgcmV0dXJuIHF0CiAgdHJhbnNwb3NlX2ZuID0gdHJhbnNwb3NlLmxoc19zY2FsZV90cmFuc3Bvc2VfdG9fb3V0cHV0CiAgaWYgaXNfcmhzOgogICAgdHJhbnNwb3NlX2ZuID0gdHJhbnNwb3NlLnJoc19zY2FsZV90cmFuc3Bvc2VfdG9fb3V0cHV0CiAgcXQuc2NhbGVfdCA9IFsKICAgICAgdHJhbnNwb3NlX2ZuKHNjYWxlLCBkaW1lbnNpb25fbnVtYmVycywgbGhzX3NoYXBlLCByaHNfc2hhcGUpCiAgICAgIGZvciBzY2FsZSBpbiBxdC5zY2FsZQogIF0KICByZXR1cm4gcXQKY2xhc3MgQXF0RG90R2VuZXJhbChubi5Nb2R1bGUpOgogICIiIkEgbGF5ZXIgdGhhdCBjYW4gYmUgaW5qZWN0ZWQgaW50byBmbGF4Lm5uLkRlbnNlLCBldGMuIiIiCiAgY2ZnOiBOb25lIHwgYXF0X2RvdF9nZW5lcmFsLkRvdEdlbmVyYWwgPSBOb25lCiAgcHJuZ19uYW1lOiBOb25lIHwgc3RyID0gJ3BhcmFtcycKICAjIFRPRE8obGV3KTogc3BsaXQgb3V0IHNlcGFyYXRlIGNsYXNzIGZvciBlYWNoIHNpZGUuCiAgIyBRdWFudCBtb2RlIGRldGVybWluZXMgd2hldGhlciBmbGF4IHZhcmlhYmxlcyBhcmUgY3JlYXRlZCB0byBzdG9yZSBxdWFudGl6ZWQKICAjIGlucHV0cy4gUmVmZXIgdG8gdGhlIEZyZWV6ZXIgZG9jIHN0ciB0byBzZWUgdmFyaWFibGUgY3JlYXRpb24gaW4gZWFjaCBtb2RlLgogIGxoc19xdWFudF9tb2RlOiBRdWFudE1vZGUgPSBRdWFudE1vZGUuVFJBSU4KICAjIGFwcGx5X3F1YW50X21vZGUgZGV0ZXJtaW5lcyBpZiB1c2luZyBGcmVlemVyIGluIGNmZy5nZXQvc2V0X3RlbnNvcgogIGxoc19hcHBseV9xdWFudF9tb2RlOiBib29sID0gVHJ1ZQogIGxoc192YXJfbmFtZTogc3RyID0gJ3FsaHMnCiAgbGhzX3F0ZW5zb3I6IE5vbmUgfCBhcXRfdGVuc29yLlFUZW5zb3IgPSBOb25lCiAgcmhzX3F1YW50X21vZGU6IFF1YW50TW9kZSA9IFF1YW50TW9kZS5UUkFJTgogIHJoc19hcHBseV9xdWFudF9tb2RlOiBib29sID0gVHJ1ZQogIHJoc192YXJfbmFtZTogc3RyID0gJ3FyaHMnCiAgcmhzX3F0ZW5zb3I6IE5vbmUgfCBhcXRfdGVuc29yLlFUZW5zb3IgPSBOb25lCiAgIyBWYXJpYWJsZXMgb25seSBmb3IgdGhlIGxlZ2FjeSBGcmVlemVyLgogIGxoc19pbml0OiBubi5pbml0aWFsaXplcnMuSW5pdGlhbGl6ZXIgPSBqbnAuemVyb3MKICBsaHNfc2NhbGVfaW5pdDogbm4uaW5pdGlhbGl6ZXJzLkluaXRpYWxpemVyID0gam5wLnplcm9zCiAgcmhzX2luaXQ6IG5uLmluaXRpYWxpemVycy5Jbml0aWFsaXplciA9IGpucC56ZXJvcwogIHJoc19zY2FsZV9pbml0OiBubi5pbml0aWFsaXplcnMuSW5pdGlhbGl6ZXIgPSBqbnAuemVyb3MKICAjIFZhcmlhYmxlcyBvbmx5IGZvciB0aGUgbmV3IEZyZWV6ZXIuCiAgbGhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlcjogTm9uZSB8IEF4aXNNZXRhZGF0YVdyYXBwZXIgPSBOb25lCiAgcmhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlcjogTm9uZSB8IEF4aXNNZXRhZGF0YVdyYXBwZXIgPSBOb25lCiAgIyBGcmVlemUgbW9kZS4gU2V0IGFzIEZyZWV6ZXJNb2RlLkNBTElCUkFUSU9OIHRvIHN0b3JlIG9ubHkgc2NhbGVzOyBzZXQgYXMKICAjIENBTElCUkFUSU9OX0FORF9WQUxVRSB0byBzdG9yZSBib3RoIHNjYWxlcyBhbmQgcXVhbnRpemVkIHZhbHVlcy4KICBsaHNfZnJlZXplX21vZGU6IEZyZWV6ZXJNb2RlID0gRnJlZXplck1vZGUuTk9ORQogIHJoc19mcmVlemVfbW9kZTogRnJlZXplck1vZGUgPSBGcmVlemVyTW9kZS5OT05FCiAgIyBJZiB5b3Ugd2FudCB1c2UgJ3BhcmFtcycgbWFrZSBzdXJlIHRoYXQgdGhlcmUgaXMgYW5vdGhlciBtZWNoYW5pc20gdG8gaGlkZQogICMgdGhlc2UgdmFyaWFibGVzIGZyb20gdGhlIG9wdGltaXplci4KICBxdWFudF9jb2xsZWN0aW9uOiBzdHIgPSAnYXF0JwogICMgVGlsaW5nIGNvbmZpZ3MuIHRpbGxpbmdfZm4gaXMgdmFsaWQgb25seSB3aGVuIHRpbGluZ19jZmcgaXMgTm9uZS4KICB0aWxpbmdfY2ZnOiBOb25lIHwgdGlsZWRfZG90X2dlbmVyYWwuQ2ZnID0gTm9uZQogIHRpbGluZ19mbjogTm9uZSB8IERvdEdlbmVyYWxUaWxpbmdGbiA9IE5vbmUKICAjIElmIHNldCB0byBUcnVlLCB1c2UgdGhlIGN1cnJlbnQgRnJlZXplci4gT3RoZXJ3aXNlLCB1c2UgdGhlIG5ldwogICMgUXVhbnRGcmVlemVyLgogIHVzZV9sZWdhY3lfZnJlZXplcjogYm9vbCA9IFRydWUKICBkZWYgbWFrZV9hcXRfZGcoCiAgICAgIHNlbGYsCiAgICAgIGxoc19zaGFwZSwKICAgICAgcmhzX3NoYXBlLAogICAgICBkaW1lbnNpb25fbnVtYmVyczogdHVwbGVbSXRlcmFibGVbaW50XSwgSXRlcmFibGVbaW50XV0sCiAgICAgIGxoc190aWxlX21hcDogTm9uZSB8IHRpbGVkX2RvdF9nZW5lcmFsLkFxdFRpbGVNYXAgPSBOb25lLAogICAgICByaHNfdGlsZV9tYXA6IE5vbmUgfCB0aWxlZF9kb3RfZ2VuZXJhbC5BcXRUaWxlTWFwID0gTm9uZSwKICApOgogICAgaWYgc2VsZi5jZmcgaXMgTm9uZToKICAgICAgcmV0dXJuIGpheC5sYXguZG90X2dlbmVyYWwKICAgIGNmZyA9IGNvcHkuZGVlcGNvcHkoc2VsZi5jZmcpCiAgICBsaHNfc2NhbGVfc2hhcGUgPSBsaXN0KGxoc19zaGFwZSkKICAgIHJoc19zY2FsZV9zaGFwZSA9IGxpc3QocmhzX3NoYXBlKQogICAgKGNvbnRyLCBfKSA9IGRpbWVuc2lvbl9udW1iZXJzCiAgICBmb3IgbGksIHJpIGluIHppcCgqY29udHIpOgogICAgICBsaHNfc2NhbGVfc2hhcGVbbGldID0gMQogICAgICByaHNfc2NhbGVfc2hhcGVbcmldID0gMQogICAgbGhzX3NjYWxlID0gdHJhbnNwb3NlLmxoc19zY2FsZV90cmFuc3Bvc2VfdG9fb3V0cHV0KAogICAgICAgIGpucC56ZXJvcyhsaHNfc2NhbGVfc2hhcGUpLCBkaW1lbnNpb25fbnVtYmVycywgbGhzX3NoYXBlLCByaHNfc2hhcGUKICAgICkKICAgIGFzc2VydCBsaHNfc2NhbGUgaXMgbm90IE5vbmUKICAgIGxoc19zY2FsZV9zaGFwZSA9IGxoc19zY2FsZS5zaGFwZQogICAgcmhzX3NjYWxlID0gdHJhbnNwb3NlLnJoc19zY2FsZV90cmFuc3Bvc2VfdG9fb3V0cHV0KAogICAgICAgIGpucC56ZXJvcyhyaHNfc2NhbGVfc2hhcGUpLCBkaW1lbnNpb25fbnVtYmVycywgbGhzX3NoYXBlLCByaHNfc2hhcGUKICAgICkKICAgIGFzc2VydCByaHNfc2NhbGUgaXMgbm90IE5vbmUKICAgIHJoc19zY2FsZV9zaGFwZSA9IHJoc19zY2FsZS5zaGFwZQogICAgcmhzX3FtID0gc2VsZi5yaHNfcXVhbnRfbW9kZQogICAgbGhzX3FtID0gc2VsZi5saHNfcXVhbnRfbW9kZQogICAgYXNzZXJ0IGlzaW5zdGFuY2UoCiAgICAgICAgY2ZnLmZ3ZC5kZ19xdWFudGl6ZXIsIGFxdF9kb3RfZ2VuZXJhbC5EZWZhdWx0RG90R2VuZXJhbFF1YW50aXplcgogICAgKQogICAgbGhzX3FfZHR5cGUgPSBjZmcuZndkLmRnX3F1YW50aXplci5saHMubnVtZXJpY3MuZ2V0X2R0eXBlKCkKICAgIHJoc19xX2R0eXBlID0gY2ZnLmZ3ZC5kZ19xdWFudGl6ZXIucmhzLm51bWVyaWNzLmdldF9kdHlwZSgpCiAgICBpZiBzZWxmLnVzZV9sZWdhY3lfZnJlZXplcjoKICAgICAgbGhzX2ZyZWV6ZXIgPSBGcmVlemVyKAogICAgICAgICAgbmFtZT1zZWxmLmxoc192YXJfbmFtZSwKICAgICAgICAgIHF1YW50X21vZGU9bGhzX3FtLAogICAgICAgICAgcV9zaGFwZT1saHNfc2hhcGUsCiAgICAgICAgICBxX2R0eXBlPWxoc19xX2R0eXBlLAogICAgICAgICAgcV9pbml0PXNlbGYubGhzX2luaXQsCiAgICAgICAgICBzX3NoYXBlPWxoc19zY2FsZV9zaGFwZSwKICAgICAgICAgIHNfaW5pdD1zZWxmLmxoc19zY2FsZV9pbml0LAogICAgICAgICAgcXVhbnRfY29sbGVjdGlvbj1zZWxmLnF1YW50X2NvbGxlY3Rpb24sCiAgICAgICkKICAgICAgcmhzX2ZyZWV6ZXIgPSBGcmVlemVyKAogICAgICAgICAgbmFtZT1zZWxmLnJoc192YXJfbmFtZSwKICAgICAgICAgIHF1YW50X21vZGU9cmhzX3FtLAogICAgICAgICAgcV9zaGFwZT1yaHNfc2hhcGUsCiAgICAgICAgICBxX2R0eXBlPXJoc19xX2R0eXBlLAogICAgICAgICAgcV9pbml0PXNlbGYucmhzX2luaXQsCiAgICAgICAgICBzX3NoYXBlPXJoc19zY2FsZV9zaGFwZSwKICAgICAgICAgIHNfaW5pdD1zZWxmLnJoc19zY2FsZV9pbml0LAogICAgICAgICAgcXVhbnRfY29sbGVjdGlvbj1zZWxmLnF1YW50X2NvbGxlY3Rpb24sCiAgICAgICkKICAgIGVsc2U6CiAgICAgIGxoc19jYSwgcmhzX2NhID0gY29udHIKICAgICAgbGhzX2luaXRfd3JhcHBlciA9IGZ1bmN0b29scy5wYXJ0aWFsKAogICAgICAgICAgX2ZyZWV6ZXJfcXRlbnNvcl9pbml0X3dyYXBwZXIsCiAgICAgICAgICBjb250cmFjdGluZ19heGlzPWxoc19jYSwKICAgICAgICAgIGF4aXNfbWV0YWRhdGFfd3JhcHBlcj1zZWxmLmxoc19heGlzX21ldGFkYXRhX3dyYXBwZXIsCiAgICAgICAgICB0aWxlX21hcD1saHNfdGlsZV9tYXAsCiAgICAgICkKICAgICAgcmhzX2luaXRfd3JhcHBlciA9IGZ1bmN0b29scy5wYXJ0aWFsKAogICAgICAgICAgX2ZyZWV6ZXJfcXRlbnNvcl9pbml0X3dyYXBwZXIsCiAgICAgICAgICBjb250cmFjdGluZ19heGlzPXJoc19jYSwKICAgICAgICAgIGF4aXNfbWV0YWRhdGFfd3JhcHBlcj1zZWxmLnJoc19heGlzX21ldGFkYXRhX3dyYXBwZXIsCiAgICAgICAgICB0aWxlX21hcD1yaHNfdGlsZV9tYXAsCiAgICAgICkKICAgICAgbGhzX2ZyZWV6ZXIgPSBnZW5lcmFsX2ZyZWV6ZXIuRnJlZXplcigKICAgICAgICAgIG5hbWU9c2VsZi5saHNfdmFyX25hbWUsCiAgICAgICAgICBtb2RlPV9RVUFOVF9UT19GUkVFWkVSX01PREVbbGhzX3FtXSwKICAgICAgICAgIGNvbGxlY3Rpb249c2VsZi5xdWFudF9jb2xsZWN0aW9uLAogICAgICAgICAgYXhpc19tZXRhZGF0YV93cmFwcGVyPWxoc19pbml0X3dyYXBwZXIsCiAgICAgICkKICAgICAgcmhzX2ZyZWV6ZXIgPSBnZW5lcmFsX2ZyZWV6ZXIuRnJlZXplcigKICAgICAgICAgIG5hbWU9c2VsZi5yaHNfdmFyX25hbWUsCiAgICAgICAgICBtb2RlPV9RVUFOVF9UT19GUkVFWkVSX01PREVbcmhzX3FtXSwKICAgICAgICAgIGNvbGxlY3Rpb249c2VsZi5xdWFudF9jb2xsZWN0aW9uLAogICAgICAgICAgYXhpc19tZXRhZGF0YV93cmFwcGVyPXJoc19pbml0X3dyYXBwZXIsCiAgICAgICkKICAgIHBybmdfbmFtZSA9IHNlbGYucHJuZ19uYW1lCiAgICBrZXkgPSBzZWxmLm1ha2Vfcm5nKHBybmdfbmFtZSkgaWYgcHJuZ19uYW1lIGlzIG5vdCBOb25lIGVsc2UgTm9uZQogICAgY2ZnID0gY29uZmlnLnNldF9jb250ZXh0KAogICAgICAgIGNmZywKICAgICAgICBrZXksCiAgICAgICAgdHJhaW5fc3RlcD1Ob25lLAogICAgICAgIGxoc19xdWFudF9tb2RlPXNlbGYubGhzX3F1YW50X21vZGUsCiAgICAgICAgcmhzX3F1YW50X21vZGU9c2VsZi5yaHNfcXVhbnRfbW9kZSwKICAgICkKICAgIGRlZiByZXRfZGcoCiAgICAgICAgbGhzLAogICAgICAgIHJocywKICAgICAgICBkaW1lbnNpb25fbnVtYmVycywKICAgICAgICBwcmVjaXNpb249Tm9uZSwKICAgICAgICBwcmVmZXJyZWRfZWxlbWVudF90eXBlPU5vbmUsCiAgICApOgogICAgICBkZWwgcHJlZmVycmVkX2VsZW1lbnRfdHlwZQogICAgICBhc3NlcnQgKAogICAgICAgICAgcHJlY2lzaW9uIGlzIE5vbmUKICAgICAgKSwgZidQcmVjaXNpb24ge3ByZWNpc2lvbn0gcmVxdWVzdGVkIHRvZ2V0aGVyIHdpdGggcXVhbnRpemF0aW9uLicKICAgICAgIyBUT0RPKHlpY2hpemgpOiBhc3NlcnRpbmcgeGhzIGR0eXBlIG9ubHkgd2hlbiBhcHBseV9xdWFudF9tb2RlPUZhbHNlCiAgICAgICMgYW5kIGNmZy5nZXRfcXRlbnNvcigpIGlzIE5vbmUKICAgICAgbXNnID0gJ0FRVCBpcyBub3QgeWV0IG9wdGltaXplZCB0byBhY2NlcHQgcXVhbnRpemVkIHR5cGVzIGRpcmVjdGx5LiAnCiAgICAgIG1zZyArPSBmJ2xocy5kdHlwZToge2xocy5kdHlwZX0sIHJocy5kdHlwZToge3Jocy5kdHlwZX0nCiAgICAgIGFzc2VydCBsaHMuZHR5cGUgaW4gW2pucC5iZmxvYXQxNiwgam5wLmZsb2F0MzIsIGpucC5mbG9hdDE2XSwgbXNnCiAgICAgIGFzc2VydCByaHMuZHR5cGUgaW4gW2pucC5iZmxvYXQxNiwgam5wLmZsb2F0MzIsIGpucC5mbG9hdDE2XSwgbXNnCiAgICAgIGNmZy5hc3NlcnRfY29uZmlnX3ZhbGlkaXR5KCkKICAgICAgIyBHZXR0ZXIKICAgICAgbGhzX2FwcGx5X3F1YW50X21vZGUgPSBzZWxmLmxoc19hcHBseV9xdWFudF9tb2RlCiAgICAgIHJoc19hcHBseV9xdWFudF9tb2RlID0gc2VsZi5yaHNfYXBwbHlfcXVhbnRfbW9kZQogICAgICBsaHNfcXQgPSBsaHNfZnJlZXplci5nZXQoKSBpZiBsaHNfYXBwbHlfcXVhbnRfbW9kZSBlbHNlIHNlbGYubGhzX3F0ZW5zb3IKICAgICAgcmhzX3F0ID0gcmhzX2ZyZWV6ZXIuZ2V0KCkgaWYgcmhzX2FwcGx5X3F1YW50X21vZGUgZWxzZSBzZWxmLnJoc19xdGVuc29yCiAgICAgICMgUmVjb3ZlciBzY2FsZSBmcm9tIHNjYWxlX3QsIGlmIG5lY2Vzc2FyeS4KICAgICAgIyBUaGUgcXVhbnRpemVkIHRlbnNvciBsb2FkZWQgZnJvbSB0aGUgbGVnYWN5IGZyZWV6ZXIgaGFzIG9ubHkgc2NhbGVfdC4KICAgICAgbGhzX3F0ID0gX21heWJlX3JlY292ZXJfc2NhbGVfZnJvbV9zY2FsZV90KAogICAgICAgICAgbGhzX3F0LCBkaW1lbnNpb25fbnVtYmVycywgRmFsc2UsIGxoc19zaGFwZSwgcmhzX3NoYXBlCiAgICAgICkKICAgICAgcmhzX3F0ID0gX21heWJlX3JlY292ZXJfc2NhbGVfZnJvbV9zY2FsZV90KAogICAgICAgICAgcmhzX3F0LCBkaW1lbnNpb25fbnVtYmVycywgVHJ1ZSwgbGhzX3NoYXBlLCByaHNfc2hhcGUKICAgICAgKQogICAgICBjZmcuYXBwbHlfY3VzdG9tX3ZqcF9vbl9qYXggPSBGYWxzZQogICAgICBvdXQsIChvdXRfbGhzX3F0LCBvdXRfcmhzX3F0KSA9IGFxdF9mbGF4X2RnX2NvcmUuZGdfY29yZV9mbGF4X2xpZnRlZCgKICAgICAgICAgIGxocywgcmhzLCBsaHNfcXQsIHJoc19xdCwgZGltZW5zaW9uX251bWJlcnMsIHNlbGYsIGNmZwogICAgICApCiAgICAgICMgUmVtb3ZlIHF2YWx1ZSBvZiB0aGUgYWN0aXZhdGlvbiB0byBub3QgdG8gc3RvcmUgaXQgaW4gRnJlZXplci4KICAgICAgbWF0Y2ggc2VsZi5saHNfZnJlZXplX21vZGU6CiAgICAgICAgY2FzZSBGcmVlemVyTW9kZS5OT05FOgogICAgICAgICAgaWYgc2VsZi5saHNfYXBwbHlfcXVhbnRfbW9kZSBhbmQgc2VsZi5saHNfcXVhbnRfbW9kZSBpbiB7CiAgICAgICAgICAgICAgUXVhbnRNb2RlLkNPTlZFUlQsCiAgICAgICAgICAgICAgUXVhbnRNb2RlLlNFUlZFLAogICAgICAgICAgfToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignRnJlZXplciBpcyB1c2VkIHdpdGggRnJlZXplciBtb2RlIE5PTkUuJykKICAgICAgICBjYXNlIEZyZWV6ZXJNb2RlLkNBTElCUkFUSU9OOgogICAgICAgICAgb3V0X2xoc19xdCA9IG91dF9saHNfcXQud2l0aG91dF9xdmFsdWUoKQogICAgICAgIGNhc2UgRnJlZXplck1vZGUuQ0FMSUJSQVRJT05fQU5EX1ZBTFVFOgogICAgICAgICAgcGFzcwogICAgICAgIGNhc2UgXzoKICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ1Vua25vd24gZnJlZXplIG1vZGU6ICVzJyAlIHNlbGYubGhzX2ZyZWV6ZV9tb2RlKQogICAgICBtYXRjaCBzZWxmLnJoc19mcmVlemVfbW9kZToKICAgICAgICBjYXNlIEZyZWV6ZXJNb2RlLk5PTkU6CiAgICAgICAgICBpZiBzZWxmLnJoc19hcHBseV9xdWFudF9tb2RlIGFuZCBzZWxmLnJoc19xdWFudF9tb2RlIGluIHsKICAgICAgICAgICAgICBRdWFudE1vZGUuQ09OVkVSVCwKICAgICAgICAgICAgICBRdWFudE1vZGUuU0VSVkUsCiAgICAgICAgICB9OgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdGcmVlemVyIGlzIHVzZWQgd2l0aCBGcmVlemVyIG1vZGUgTk9ORS4nKQogICAgICAgIGNhc2UgRnJlZXplck1vZGUuQ0FMSUJSQVRJT046CiAgICAgICAgICBvdXRfcmhzX3F0ID0gb3V0X3Joc19xdC53aXRob3V0X3F2YWx1ZSgpCiAgICAgICAgY2FzZSBGcmVlemVyTW9kZS5DQUxJQlJBVElPTl9BTkRfVkFMVUU6CiAgICAgICAgICBwYXNzCiAgICAgICAgY2FzZSBfOgogICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignVW5rbm93biBmcmVlemUgbW9kZTogJXMnICUgc2VsZi5yaHNfZnJlZXplX21vZGUpCiAgICAgICMgU2V0dGVyCiAgICAgIGNhbGliX2NvbnRyYWN0aW5nX2F4aXMgPSBhcXRfZG90X2dlbmVyYWwuQ2FsaWJyYXRpb25Nb2RlLkNPTlRSQUNUSU5HX0FYSVMKICAgICAgaWYgc2VsZi51c2VfbGVnYWN5X2ZyZWV6ZXI6CiAgICAgICAgIyBXZSBuZWVkIHRvIHBvcHVsYXRlIHRoZSBzdG9yZWQgUVRlbnNvciB3aXRoIHNjYWxlX3QuCiAgICAgICAgaWYgY2ZnLmZ3ZC5saHMuY2FsaWJyYXRpb25fbW9kZSA9PSBjYWxpYl9jb250cmFjdGluZ19heGlzOgogICAgICAgICAgb3V0X2xoc19xdCA9IF9wb3B1bGF0ZV9zY2FsZV90KAogICAgICAgICAgICAgIG91dF9saHNfcXQsIGRpbWVuc2lvbl9udW1iZXJzLCBGYWxzZSwgbGhzX3NoYXBlLCByaHNfc2hhcGUKICAgICAgICAgICkKICAgICAgICBpZiBjZmcuZndkLnJocy5jYWxpYnJhdGlvbl9tb2RlID09IGNhbGliX2NvbnRyYWN0aW5nX2F4aXM6CiAgICAgICAgICBvdXRfcmhzX3F0ID0gX3BvcHVsYXRlX3NjYWxlX3QoCiAgICAgICAgICAgICAgb3V0X3Joc19xdCwgZGltZW5zaW9uX251bWJlcnMsIFRydWUsIGxoc19zaGFwZSwgcmhzX3NoYXBlCiAgICAgICAgICApCiAgICAgIGlmIHNlbGYubGhzX2FwcGx5X3F1YW50X21vZGU6CiAgICAgICAgbGhzX2ZyZWV6ZXIuc2V0KG91dF9saHNfcXQpCiAgICAgIGlmIHNlbGYucmhzX2FwcGx5X3F1YW50X21vZGU6CiAgICAgICAgcmhzX2ZyZWV6ZXIuc2V0KG91dF9yaHNfcXQpCiAgICAgIHJldHVybiBvdXQKICAgIHJldHVybiByZXRfZGcKICBAbm4uY29tcGFjdAogIGRlZiBfX2NhbGxfXygKICAgICAgc2VsZiwKICAgICAgbGhzLAogICAgICByaHMsCiAgICAgIGRpbWVuc2lvbl9udW1iZXJzLAogICAgICBwcmVjaXNpb24sCiAgICAgIHByZWZlcnJlZF9lbGVtZW50X3R5cGU9Tm9uZSwKICApOgogICAgdGlsaW5nX2NmZyA9IHNlbGYudGlsaW5nX2NmZwogICAgaWYgdGlsaW5nX2NmZyBpcyBOb25lIGFuZCBzZWxmLnRpbGluZ19mbiBpcyBub3QgTm9uZToKICAgICAgdGlsaW5nX2NmZyA9IHNlbGYudGlsaW5nX2ZuKGxocywgcmhzLCBkaW1lbnNpb25fbnVtYmVycykKICAgIGlmIHRpbGluZ19jZmcgaXMgbm90IE5vbmU6CiAgICAgIHhsaHMsIHhyaHMgPSB0aWxlZF9kb3RfZ2VuZXJhbC5nZW5lcmF0ZV90aWxpbmdfc3RhdGVzX2Zvcl9kb3RfZ2VuZXJhbCgKICAgICAgICAgIHRpbGluZ19jZmcsIGxocywgcmhzLCBkaW1lbnNpb25fbnVtYmVycwogICAgICApCiAgICAgICMgRXh0cmFjdCB0aWxlZCBpbnB1dCBzaGFwZXMgYW5kIGRpbWVuc2lvbiBudW1iZXJzIGZyb20gamF4cHIKICAgICAgZGVmIGR1bW15X3RpbGVkX2RnKGxoc19pbiwgcmhzX2luKToKICAgICAgICByZXR1cm4gdGlsZWRfZG90X2dlbmVyYWwudGlsZWRfZG90X2dlbmVyYWwoCiAgICAgICAgICAgIHRpbGluZ19jZmcsIGxoc19pbiwgcmhzX2luLCBkaW1lbnNpb25fbnVtYmVycwogICAgICAgICkKICAgICAgdGlsZWRfZGdfamF4cHIgPSBqYXgubWFrZV9qYXhwcihkdW1teV90aWxlZF9kZykobGhzLCByaHMpCiAgICAgIGRnX2VxbiA9IFtlcW4gZm9yIGVxbiBpbiB0aWxlZF9kZ19qYXhwci5lcW5zIGlmICdkb3RfZ2VuZXJhbCcgaW4gc3RyKGVxbildCiAgICAgIGFzc2VydCBsZW4oZGdfZXFuKSA9PSAxLCAnTXVsdGlwbGUgZGcgY2FsbHMgYXJlIGZvdW5kIGluIHRpbGVkIGRnIGpheHByLicKICAgICAgbGhzX2ludmFyLCByaHNfaW52YXIgPSBkZ19lcW5bMF0uaW52YXJzCiAgICAgIHRpbGVkX2xoc19zaGFwZSA9IGxoc19pbnZhci5hdmFsLnNoYXBlCiAgICAgIHRpbGVkX3Joc19zaGFwZSA9IHJoc19pbnZhci5hdmFsLnNoYXBlCiAgICAgIHRpbGVkX2RpbWVuc2lvbl9udW1iZXJzID0gZGdfZXFuWzBdLnBhcmFtc1snZGltZW5zaW9uX251bWJlcnMnXQogICAgICAjIFVzZSB0aWxlZCBpbnB1dCBzaGFwZXMgYW5kIGRpbWVuc2lvbiBudW1iZXJzIHRvIGNyZWF0ZSBhcXRfZGcgdGhhdAogICAgICAjIHdpbGwgYmUgaW5qZWN0ZWQgdG8gdGlsZWRfZG90X2dlbmVyYWwKICAgICAgYXF0X2RnID0gc2VsZi5tYWtlX2FxdF9kZygKICAgICAgICAgIHRpbGVkX2xoc19zaGFwZSwKICAgICAgICAgIHRpbGVkX3Joc19zaGFwZSwKICAgICAgICAgIHRpbGVkX2RpbWVuc2lvbl9udW1iZXJzLAogICAgICAgICAgbGhzX3RpbGVfbWFwPXhsaHMudGlsZV9tYXAsCiAgICAgICAgICByaHNfdGlsZV9tYXA9eHJocy50aWxlX21hcCwKICAgICAgKQogICAgICAjIFdlIGludGVncmF0ZSB0aWxpbmcgaGVyZSBhbmQgbm90IG9uIEpheCBsZXZlbCwgc28gdGhhdCB0aGUgRnJlZXplcnMKICAgICAgIyBvYnNlcnZlIHRpbGVkIHNoYXBlcy4KICAgICAgcmV0X2RnID0gZnVuY3Rvb2xzLnBhcnRpYWwoCiAgICAgICAgICB0aWxlZF9kb3RfZ2VuZXJhbC50aWxlZF9kb3RfZ2VuZXJhbCwKICAgICAgICAgIHRpbGluZ19jZmcsCiAgICAgICAgICBkb3RfZ2VuZXJhbD1hcXRfZGcsCiAgICAgICkKICAgIGVsc2U6CiAgICAgIHJldF9kZyA9IHNlbGYubWFrZV9hcXRfZGcobGhzLnNoYXBlLCByaHMuc2hhcGUsIGRpbWVuc2lvbl9udW1iZXJzKQogICAgcmV0dXJuIHJldF9kZygKICAgICAgICBsaHMsCiAgICAgICAgcmhzLAogICAgICAgIGRpbWVuc2lvbl9udW1iZXJzLAogICAgICAgIHByZWNpc2lvbiwKICAgICAgICBwcmVmZXJyZWRfZWxlbWVudF90eXBlLAogICAgKQpjbGFzcyBBcXRFaW5zdW0obm4uTW9kdWxlKToKICAiIiJRdWFudGl6ZWQgRWluc3VtIGNsYXNzIGZvciBtb2RlbCBpbmplY3Rpb24uIiIiCiAgY2ZnOiBOb25lIHwgY29uZmlnLkRvdEdlbmVyYWwgPSBOb25lCiAgcHJuZ19uYW1lOiBOb25lIHwgc3RyID0gJ3BhcmFtcycKICAjIFRPRE8obGV3KTogc3BsaXQgb3V0IHNlcGFyYXRlIGNsYXNzIGZvciBlYWNoIHNpZGUuCiAgbGhzX3F1YW50X21vZGU6IFF1YW50TW9kZSA9IFF1YW50TW9kZS5UUkFJTgogIGxoc192YXJfbmFtZTogc3RyID0gJ3FsaHMnCiAgcmhzX3F1YW50X21vZGU6IFF1YW50TW9kZSA9IFF1YW50TW9kZS5UUkFJTgogIHJoc192YXJfbmFtZTogc3RyID0gJ3FyaHMnCiAgIyBWYXJpYWJsZXMgb25seSBmb3IgdGhlIGxlZ2FjeSBGcmVlemVyLgogIGxoc19pbml0OiBubi5pbml0aWFsaXplcnMuSW5pdGlhbGl6ZXIgPSBqbnAuemVyb3MKICBsaHNfc2NhbGVfaW5pdDogbm4uaW5pdGlhbGl6ZXJzLkluaXRpYWxpemVyID0gam5wLnplcm9zCiAgcmhzX2luaXQ6IG5uLmluaXRpYWxpemVycy5Jbml0aWFsaXplciA9IGpucC56ZXJvcwogIHJoc19zY2FsZV9pbml0OiBubi5pbml0aWFsaXplcnMuSW5pdGlhbGl6ZXIgPSBqbnAuemVyb3MKICAjIFZhcmlhYmxlcyBvbmx5IGZvciB0aGUgbmV3IEZyZWV6ZXIuCiAgbGhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlcjogTm9uZSB8IEF4aXNNZXRhZGF0YVdyYXBwZXIgPSBOb25lCiAgcmhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlcjogTm9uZSB8IEF4aXNNZXRhZGF0YVdyYXBwZXIgPSBOb25lCiAgIyBGcmVlemUgbW9kZS4gU2V0IGFzIEZyZWV6ZXJNb2RlLkNBTElCUkFUSU9OIHRvIHN0b3JlIG9ubHkgc2NhbGVzOyBzZXQgYXMKICAjIENBTElCUkFUSU9OX0FORF9WQUxVRSB0byBzdG9yZSBib3RoIHNjYWxlcyBhbmQgcXVhbnRpemVkIHZhbHVlcy4KICBsaHNfZnJlZXplX21vZGU6IEZyZWV6ZXJNb2RlID0gRnJlZXplck1vZGUuTk9ORQogIHJoc19mcmVlemVfbW9kZTogRnJlZXplck1vZGUgPSBGcmVlemVyTW9kZS5OT05FCiAgIyBJZiB5b3Ugd2FudCB1c2UgJ3BhcmFtcycgbWFrZSBzdXJlIHRoYXQgdGhlcmUgaXMgYW5vdGhlciBtZWNoYW5pc20gdG8gaGlkZQogICMgdGhlc2UgdmFyaWFibGVzIGZyb20gdGhlIG9wdGltaXplci4KICBxdWFudF9jb2xsZWN0aW9uOiBzdHIgPSAnYXF0JwogIGFzc2VydF9lcW46IE5vbmUgfCBzdHIgPSBOb25lCiAgYXNzZXJ0X2xoc19zaGFwZTogTm9uZSB8IHV0aWxzLlNoYXBlVGVtcGxhdGUgPSBOb25lCiAgYXNzZXJ0X3Joc19zaGFwZTogTm9uZSB8IHV0aWxzLlNoYXBlVGVtcGxhdGUgPSBOb25lCiAgdGlsZV9zaXplczogTm9uZSB8IHRpbGVkX2RvdF9nZW5lcmFsLkVpbnN1bVRpbGVTaXplcyA9IE5vbmUKICB0aWxpbmdfZm46IE5vbmUgfCBFaW5zdW1UaWxpbmdGbiA9IE5vbmUKICAjIElmIHNldCB0byBUcnVlLCB1c2UgdGhlIGN1cnJlbnQgRnJlZXplci4gT3RoZXJ3aXNlLCB1c2UgdGhlIG5ldwogICMgUVRlbnNvckZyZWV6ZXIuCiAgdXNlX2xlZ2FjeV9mcmVlemVyOiBib29sID0gVHJ1ZQogIEBubi5jb21wYWN0CiAgZGVmIF9fY2FsbF9fKAogICAgICBzZWxmLAogICAgICBlcW4sCiAgICAgIGxoc19nOiBqbnAubmRhcnJheSB8IGFxdF90ZW5zb3IuUVRlbnNvciwKICAgICAgcmhzX2c6IGpucC5uZGFycmF5IHwgYXF0X3RlbnNvci5RVGVuc29yLAogICk6CiAgICBpZiBzZWxmLmFzc2VydF9lcW4gaXMgbm90IE5vbmU6CiAgICAgIHV0aWxzLmFzc2VydF9lcShlcW4sIHNlbGYuYXNzZXJ0X2VxbiwgJ2VpbnN1bV9lcW4nKQogICAgaWYgc2VsZi5hc3NlcnRfbGhzX3NoYXBlIGlzIG5vdCBOb25lOgogICAgICB1dGlscy5hc3NlcnRfc2hhcGUobGhzX2cuc2hhcGUsIHNlbGYuYXNzZXJ0X2xoc19zaGFwZSwgJ2xocy5zaGFwZScpCiAgICBpZiBzZWxmLmFzc2VydF9yaHNfc2hhcGUgaXMgbm90IE5vbmU6CiAgICAgIHV0aWxzLmFzc2VydF9zaGFwZShyaHNfZy5zaGFwZSwgc2VsZi5hc3NlcnRfcmhzX3NoYXBlLCAncmhzLnNoYXBlJykKICAgIGNmZyA9IHNlbGYuY2ZnCiAgICBsaHNfaXNfcXQgPSBpc2luc3RhbmNlKGxoc19nLCBhcXRfdGVuc29yLlFUZW5zb3IpCiAgICByaHNfaXNfcXQgPSBpc2luc3RhbmNlKHJoc19nLCBhcXRfdGVuc29yLlFUZW5zb3IpCiAgICBtc2cgPSAnQXF0IGNvbmZpZyBpcyBOb25lIGJ1dCBpbnB1dHMgdG8gQXF0RWluc3VtIGFyZSBRVGVuc29yLicKICAgIGFzc2VydCBub3QgKChsaHNfaXNfcXQgb3IgcmhzX2lzX3F0KSBhbmQgY2ZnIGlzIE5vbmUpLCBtc2cKICAgICMgd2hlbiBpbnB1dHMgYXJlIHF0ZW5zb3IsIHhoc19pbiBpcyBhIGR1bW15IGlucHV0IHRoYXQgd2lsbCBiZSBjb25zdW1lZCBieQogICAgIyBsYXggZWluc3VtIEFQSSwgYnV0IGl0IGlzIG5vdCB1c2VkIGZvciBjb21wdXRhdGlvbiBpbiBhcXRfZGcgYmVjYXVzZSBpdAogICAgIyB3aWxsIGJlIG92ZXJ3cml0dGVuIGJ5IGdldF90ZW5zb3IoKQogICAgIyBUT0RPKGxldyk6IFdlIGNhbiBwYXNzIFFUZW5zb3IgdG8gbGF4X251bXB5Ll9laW5zdW0gaWYgd2UgYWRkIHNvbWUKICAgICMgc3BlY2lmaWMgbWV0aG9kcyB0byBRVGVuc29yLgogICAgbGhzX2luID0gam5wLnplcm9zX2xpa2UobGhzX2cucXZhbHVlKSBpZiBsaHNfaXNfcXQgZWxzZSBsaHNfZwogICAgcmhzX2luID0gam5wLnplcm9zX2xpa2UocmhzX2cucXZhbHVlKSBpZiByaHNfaXNfcXQgZWxzZSByaHNfZwogICAgIyBTZXQgdGhlIHR5cGVzIG9mIGR1bW15IGlucHV0IHRvIHRoZSBzYW1lIGFzIG9yaWdpbmFsIGlucHV0LCB0byBwcmV2ZW50IGl0CiAgICAjIGZyb20gYmVpbmcgcmVqZWN0ZWQgYnkgYXNzZXJ0aW9ucyBpbiBhcXRfZG90X2dlbmVyYWwucHksIGxpbmUgNTIyLTUyNiBhbmQKICAgICMgNDE0LgogICAgbGhzX2luLCByaHNfaW4gPSBhcXRfcHJvbW90ZV9kdHlwZShsaHNfaW4sIHJoc19pbikKICAgICMgeWVzX3N3YXAgPSB3aGV0aGVyIGVpbnN1bSBzd2FwcyBbbGhzLHJoc10gd2hlbiBwYXNzaW5nIHRoZW0gdG8gZG90X2dlbmVyYWwKICAgIGVpbnN1bSA9IGZ1bmN0b29scy5wYXJ0aWFsKGFxdF9kb3RfZ2VuZXJhbC5laW5zdW0sIGVxbj1lcW4pCiAgICBhID0gamF4Lm1ha2VfamF4cHIoZWluc3VtKShsaHM9bGhzX2luLCByaHM9cmhzX2luKQogICAgW2xoc19nX2lkLCByaHNfZ19pZF0gPSBhLmVxbnNbMF0uaW52YXJzCiAgICBbbGhzX2xfaWQsIHJoc19sX2lkXSA9IGEuamF4cHIuaW52YXJzCiAgICBub3Rfc3dhcCA9IGxoc19nX2lkID09IGxoc19sX2lkIGFuZCByaHNfZ19pZCA9PSByaHNfbF9pZAogICAgeWVzX3N3YXAgPSBsaHNfZ19pZCA9PSByaHNfbF9pZCBhbmQgcmhzX2dfaWQgPT0gbGhzX2xfaWQKICAgIGFzc2VydCBub3Rfc3dhcCAhPSB5ZXNfc3dhcAogICAgcHJuZ19uYW1lID0gc2VsZi5wcm5nX25hbWUKICAgIGxoc19xdWFudF9tb2RlID0gc2VsZi5saHNfcXVhbnRfbW9kZQogICAgbGhzX2luaXQgPSBzZWxmLmxoc19pbml0CiAgICBsaHNfYXhpc19tZXRhZGF0YV93cmFwcGVyID0gc2VsZi5saHNfYXhpc19tZXRhZGF0YV93cmFwcGVyCiAgICBsaHNfc2NhbGVfaW5pdCA9IHNlbGYubGhzX3NjYWxlX2luaXQKICAgIGxoc192YXJfbmFtZSA9IHNlbGYubGhzX3Zhcl9uYW1lCiAgICBsaHNfcXRlbnNvciA9IGxoc19nIGlmIGxoc19pc19xdCBlbHNlIE5vbmUKICAgIHJoc19xdWFudF9tb2RlID0gc2VsZi5yaHNfcXVhbnRfbW9kZQogICAgcmhzX2luaXQgPSBzZWxmLnJoc19pbml0CiAgICByaHNfYXhpc19tZXRhZGF0YV93cmFwcGVyID0gc2VsZi5yaHNfYXhpc19tZXRhZGF0YV93cmFwcGVyCiAgICByaHNfc2NhbGVfaW5pdCA9IHNlbGYucmhzX3NjYWxlX2luaXQKICAgIHJoc192YXJfbmFtZSA9IHNlbGYucmhzX3Zhcl9uYW1lCiAgICByaHNfcXRlbnNvciA9IHJoc19nIGlmIHJoc19pc19xdCBlbHNlIE5vbmUKICAgIGxoc19mcmVlemVfbW9kZSA9IHNlbGYubGhzX2ZyZWV6ZV9tb2RlCiAgICByaHNfZnJlZXplX21vZGUgPSBzZWxmLnJoc19mcmVlemVfbW9kZQogICAgcXVhbnRfY29sbGVjdGlvbiA9IHNlbGYucXVhbnRfY29sbGVjdGlvbgogICAgdGlsaW5nX2NvbmZpZyA9IE5vbmUKICAgIGlmIHNlbGYudGlsZV9zaXplcyBpcyBub3QgTm9uZToKICAgICAgdGlsaW5nX2NvbmZpZyA9IHRpbGVkX2RvdF9nZW5lcmFsLkNmZy5mcm9tX2VpbnN1bShlcW4sIHNlbGYudGlsZV9zaXplcykKICAgIGVsaWYgc2VsZi50aWxpbmdfZm4gaXMgbm90IE5vbmU6CiAgICAgIHRpbGluZ19jb25maWcgPSBzZWxmLnRpbGluZ19mbihlcW4sIGxoc19pbiwgcmhzX2luKQogICAgaWYgeWVzX3N3YXA6CiAgICAgIGlmIGNmZyBpcyBub3QgTm9uZToKICAgICAgICBjZmcgPSBjb3B5LmRlZXBjb3B5KGNmZykKICAgICAgICBjZmcuZndkLmxocywgY2ZnLmZ3ZC5yaHMgPSBjZmcuZndkLnJocywgY2ZnLmZ3ZC5saHMKICAgICAgICBjZmcuZndkLmRnX3F1YW50aXplci5zd2FwX2xoc19hbmRfcmhzKCkKICAgICAgICBjZmcuZGxocywgY2ZnLmRyaHMgPSBjZmcuZHJocywgY2ZnLmRsaHMKICAgICAgbGhzX3F1YW50X21vZGUsIHJoc19xdWFudF9tb2RlID0gcmhzX3F1YW50X21vZGUsIGxoc19xdWFudF9tb2RlCiAgICAgIGxoc19pbml0LCByaHNfaW5pdCA9IHJoc19pbml0LCBsaHNfaW5pdAogICAgICBsaHNfc2NhbGVfaW5pdCwgcmhzX3NjYWxlX2luaXQgPSByaHNfc2NhbGVfaW5pdCwgbGhzX3NjYWxlX2luaXQKICAgICAgbGhzX3Zhcl9uYW1lLCByaHNfdmFyX25hbWUgPSByaHNfdmFyX25hbWUsIGxoc192YXJfbmFtZQogICAgICBsaHNfaXNfcXQsIHJoc19pc19xdCA9IHJoc19pc19xdCwgbGhzX2lzX3F0CiAgICAgIGxoc19xdGVuc29yLCByaHNfcXRlbnNvciA9IHJoc19xdGVuc29yLCBsaHNfcXRlbnNvcgogICAgICBsaHNfYXhpc19tZXRhZGF0YV93cmFwcGVyLCByaHNfYXhpc19tZXRhZGF0YV93cmFwcGVyID0gKAogICAgICAgICAgcmhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlciwKICAgICAgICAgIGxoc19heGlzX21ldGFkYXRhX3dyYXBwZXIsCiAgICAgICkKICAgICAgbGhzX2ZyZWV6ZV9tb2RlLCByaHNfZnJlZXplX21vZGUgPSByaHNfZnJlZXplX21vZGUsIGxoc19mcmVlemVfbW9kZQogICAgICBpZiB0aWxpbmdfY29uZmlnIGlzIG5vdCBOb25lOgogICAgICAgIHRpbGluZ19jb25maWcgPSB0aWxlZF9kb3RfZ2VuZXJhbC5DZmcoCiAgICAgICAgICAgIGxocz10aWxpbmdfY29uZmlnLnJocywgcmhzPXRpbGluZ19jb25maWcubGhzCiAgICAgICAgKQogICAgYXF0X2RnID0gQXF0RG90R2VuZXJhbCgKICAgICAgICBjZmc9Y2ZnLAogICAgICAgIHBybmdfbmFtZT1wcm5nX25hbWUsCiAgICAgICAgbGhzX3F1YW50X21vZGU9bGhzX3F1YW50X21vZGUsCiAgICAgICAgIyB3aGVuIHBhc3NpbmcgcHJlLWNvbXB1dGVkIHF0ZW5zb3IgYXMgaW5wdXRzLCBhcHBseV9xdWFudF9tb2RlIGZsYWcKICAgICAgICAjIHNob3VsZCBiZSBzZXQgdG8gRmFsc2Ugc28gdGhhdCBGcmVlemVyIHdpbGwgbm90IGJlIHNldCB0byBvdmVyd3JpdGUKICAgICAgICAjIHRoZSBxdGVuc29yIHBhc3NlZCB0byBkZy4KICAgICAgICBsaHNfYXBwbHlfcXVhbnRfbW9kZT1ub3QgbGhzX2lzX3F0LCAgIyBGcmVlemVyIG5vdCB1c2VkIGlmIGxocyBpcyBxdAogICAgICAgIGxoc19pbml0PWxoc19pbml0LAogICAgICAgIGxoc19heGlzX21ldGFkYXRhX3dyYXBwZXI9bGhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlciwKICAgICAgICBsaHNfc2NhbGVfaW5pdD1saHNfc2NhbGVfaW5pdCwKICAgICAgICBsaHNfdmFyX25hbWU9bGhzX3Zhcl9uYW1lLAogICAgICAgIGxoc19xdGVuc29yPWxoc19xdGVuc29yLAogICAgICAgIHJoc19xdWFudF9tb2RlPXJoc19xdWFudF9tb2RlLAogICAgICAgIHJoc19hcHBseV9xdWFudF9tb2RlPW5vdCByaHNfaXNfcXQsICAjIEZyZWV6ZXIgbm90IHVzZWQgaWYgcmhzIGlzIHF0CiAgICAgICAgcmhzX2luaXQ9cmhzX2luaXQsCiAgICAgICAgcmhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlcj1yaHNfYXhpc19tZXRhZGF0YV93cmFwcGVyLAogICAgICAgIHJoc19zY2FsZV9pbml0PXJoc19zY2FsZV9pbml0LAogICAgICAgIHJoc192YXJfbmFtZT1yaHNfdmFyX25hbWUsCiAgICAgICAgcmhzX3F0ZW5zb3I9cmhzX3F0ZW5zb3IsCiAgICAgICAgcXVhbnRfY29sbGVjdGlvbj1xdWFudF9jb2xsZWN0aW9uLAogICAgICAgIHRpbGluZ19jZmc9dGlsaW5nX2NvbmZpZywKICAgICAgICB1c2VfbGVnYWN5X2ZyZWV6ZXI9c2VsZi51c2VfbGVnYWN5X2ZyZWV6ZXIsCiAgICAgICAgbGhzX2ZyZWV6ZV9tb2RlPWxoc19mcmVlemVfbW9kZSwKICAgICAgICByaHNfZnJlZXplX21vZGU9cmhzX2ZyZWV6ZV9tb2RlLAogICAgKQogICAgcmV0dXJuIGVpbnN1bShsaHM9bGhzX2luLCByaHM9cmhzX2luLCBkZz1hcXRfZGcpCmNsYXNzIEFxdENvbnZHZW5lcmFsRGlsYXRlZChubi5Nb2R1bGUpOgogICIiIkEgbGF5ZXIgdGhhdCBjYW4gYmUgaW5qZWN0ZWQgaW50byBmbGF4Lm5uLkRlbnNlLCBldGMuIiIiCiAgY2ZnOiBOb25lIHwgYXF0X2RvdF9nZW5lcmFsLkRvdEdlbmVyYWwgPSBOb25lCiAgcHJuZ19uYW1lOiBOb25lIHwgc3RyID0gJ3BhcmFtcycKICAjIFRPRE8obGV3KTogc3BsaXQgb3V0IHNlcGFyYXRlIGNsYXNzIGZvciBlYWNoIHNpZGUuCiAgIyBRdWFudCBtb2RlIGRldGVybWluZXMgd2hldGhlciBmbGF4IHZhcmlhYmxlcyBhcmUgY3JlYXRlZCB0byBzdG9yZSBxdWFudGl6ZWQKICAjIGlucHV0cy4gUmVmZXIgdG8gdGhlIEZyZWV6ZXIgZG9jIHN0ciB0byBzZWUgdmFyaWFibGUgY3JlYXRpb24gaW4gZWFjaCBtb2RlLgogIGxoc19xdWFudF9tb2RlOiBRdWFudE1vZGUgPSBRdWFudE1vZGUuVFJBSU4KICAjIGFwcGx5X3F1YW50X21vZGUgZGV0ZXJtaW5lcyBpZiB1c2luZyBGcmVlemVyIGluIGNmZy5nZXQvc2V0X3RlbnNvcgogIGxoc19hcHBseV9xdWFudF9tb2RlOiBib29sID0gVHJ1ZQogIGxoc192YXJfbmFtZTogc3RyID0gJ3FsaHMnCiAgbGhzX3F0ZW5zb3I6IE5vbmUgfCBhcXRfdGVuc29yLlFUZW5zb3IgPSBOb25lCiAgcmhzX3F1YW50X21vZGU6IFF1YW50TW9kZSA9IFF1YW50TW9kZS5UUkFJTgogIHJoc19hcHBseV9xdWFudF9tb2RlOiBib29sID0gVHJ1ZQogIHJoc192YXJfbmFtZTogc3RyID0gJ3FyaHMnCiAgcmhzX3F0ZW5zb3I6IE5vbmUgfCBhcXRfdGVuc29yLlFUZW5zb3IgPSBOb25lCiAgIyBWYXJpYWJsZXMgb25seSBmb3IgdGhlIG5ldyBGcmVlemVyLgogIGxoc19heGlzX21ldGFkYXRhX3dyYXBwZXI6IE5vbmUgfCBBeGlzTWV0YWRhdGFXcmFwcGVyID0gTm9uZQogIHJoc19heGlzX21ldGFkYXRhX3dyYXBwZXI6IE5vbmUgfCBBeGlzTWV0YWRhdGFXcmFwcGVyID0gTm9uZQogICMgRnJlZXplIG1vZGUuIFNldCBhcyBGcmVlemVyTW9kZS5DQUxJQlJBVElPTiB0byBzdG9yZSBvbmx5IHNjYWxlczsgc2V0IGFzCiAgIyBDQUxJQlJBVElPTl9BTkRfVkFMVUUgdG8gc3RvcmUgYm90aCBzY2FsZXMgYW5kIHF1YW50aXplZCB2YWx1ZXMuCiAgbGhzX2ZyZWV6ZV9tb2RlOiBGcmVlemVyTW9kZSA9IEZyZWV6ZXJNb2RlLk5PTkUKICByaHNfZnJlZXplX21vZGU6IEZyZWV6ZXJNb2RlID0gRnJlZXplck1vZGUuTk9ORQogICMgSWYgeW91IHdhbnQgdXNlICdwYXJhbXMnIG1ha2Ugc3VyZSB0aGF0IHRoZXJlIGlzIGFub3RoZXIgbWVjaGFuaXNtIHRvIGhpZGUKICAjIHRoZXNlIHZhcmlhYmxlcyBmcm9tIHRoZSBvcHRpbWl6ZXIuCiAgcXVhbnRfY29sbGVjdGlvbjogc3RyID0gJ2FxdCcKICBkZWYgbWFrZV9hcXRfY2coCiAgICAgIHNlbGYsCiAgKToKICAgIGlmIHNlbGYuY2ZnIGlzIE5vbmU6CiAgICAgIHJldHVybiBqYXgubGF4LmNvbnZfZ2VuZXJhbF9kaWxhdGVkCiAgICBjZmcgPSBjb3B5LmRlZXBjb3B5KHNlbGYuY2ZnKQogICAgcmhzX3FtID0gc2VsZi5yaHNfcXVhbnRfbW9kZQogICAgbGhzX3FtID0gc2VsZi5saHNfcXVhbnRfbW9kZQogICAgYXNzZXJ0IGlzaW5zdGFuY2UoCiAgICAgICAgY2ZnLmZ3ZC5kZ19xdWFudGl6ZXIsIGFxdF9kb3RfZ2VuZXJhbC5EZWZhdWx0RG90R2VuZXJhbFF1YW50aXplcgogICAgKQogICAgbGhzX2luaXRfd3JhcHBlciA9IGZ1bmN0b29scy5wYXJ0aWFsKAogICAgICAgIF9mcmVlemVyX3F0ZW5zb3JfaW5pdF93cmFwcGVyLAogICAgICAgIGNvbnRyYWN0aW5nX2F4aXM9W10sCiAgICAgICAgYXhpc19tZXRhZGF0YV93cmFwcGVyPXNlbGYubGhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlciwKICAgICAgICB0aWxlX21hcD1Ob25lLAogICAgKQogICAgcmhzX2luaXRfd3JhcHBlciA9IGZ1bmN0b29scy5wYXJ0aWFsKAogICAgICAgIF9mcmVlemVyX3F0ZW5zb3JfaW5pdF93cmFwcGVyLAogICAgICAgIGNvbnRyYWN0aW5nX2F4aXM9W10sCiAgICAgICAgYXhpc19tZXRhZGF0YV93cmFwcGVyPXNlbGYucmhzX2F4aXNfbWV0YWRhdGFfd3JhcHBlciwKICAgICAgICB0aWxlX21hcD1Ob25lLAogICAgKQogICAgbGhzX2ZyZWV6ZXIgPSBnZW5lcmFsX2ZyZWV6ZXIuRnJlZXplcigKICAgICAgICBuYW1lPXNlbGYubGhzX3Zhcl9uYW1lLAogICAgICAgIG1vZGU9X1FVQU5UX1RPX0ZSRUVaRVJfTU9ERVtsaHNfcW1dLAogICAgICAgIGNvbGxlY3Rpb249c2VsZi5xdWFudF9jb2xsZWN0aW9uLAogICAgICAgIGF4aXNfbWV0YWRhdGFfd3JhcHBlcj1saHNfaW5pdF93cmFwcGVyLAogICAgKQogICAgcmhzX2ZyZWV6ZXIgPSBnZW5lcmFsX2ZyZWV6ZXIuRnJlZXplcigKICAgICAgICBuYW1lPXNlbGYucmhzX3Zhcl9uYW1lLAogICAgICAgIG1vZGU9X1FVQU5UX1RPX0ZSRUVaRVJfTU9ERVtyaHNfcW1dLAogICAgICAgIGNvbGxlY3Rpb249c2VsZi5xdWFudF9jb2xsZWN0aW9uLAogICAgICAgIGF4aXNfbWV0YWRhdGFfd3JhcHBlcj1yaHNfaW5pdF93cmFwcGVyLAogICAgKQogICAgcHJuZ19uYW1lID0gc2VsZi5wcm5nX25hbWUKICAgIGtleSA9IHNlbGYubWFrZV9ybmcocHJuZ19uYW1lKSBpZiBwcm5nX25hbWUgaXMgbm90IE5vbmUgZWxzZSBOb25lCiAgICBjZmcgPSBjb25maWcuc2V0X2NvbnRleHQoCiAgICAgICAgY2ZnLAogICAgICAgIGtleSwKICAgICAgICB0cmFpbl9zdGVwPU5vbmUsCiAgICAgICAgbGhzX3F1YW50X21vZGU9c2VsZi5saHNfcXVhbnRfbW9kZSwKICAgICAgICByaHNfcXVhbnRfbW9kZT1zZWxmLnJoc19xdWFudF9tb2RlLAogICAgKQogICAgZGVmIHJldF9jZygKICAgICAgICBsaHMsCiAgICAgICAgcmhzLAogICAgICAgIHdpbmRvd19zdHJpZGVzLAogICAgICAgIHBhZGRpbmcsCiAgICAgICAgbGhzX2RpbGF0aW9uLAogICAgICAgIHJoc19kaWxhdGlvbiwKICAgICAgICBkaW1lbnNpb25fbnVtYmVycywKICAgICAgICBmZWF0dXJlX2dyb3VwX2NvdW50LAogICAgICAgIGJhdGNoX2dyb3VwX2NvdW50LAogICAgICAgIHByZWNpc2lvbiwKICAgICAgICBwcmVmZXJyZWRfZWxlbWVudF90eXBlLAogICAgKToKICAgICAgIyBUT0RPKHlpY2hpemgpOiBhc3NlcnRpbmcgeGhzIGR0eXBlIG9ubHkgd2hlbiBhcHBseV9xdWFudF9tb2RlPUZhbHNlCiAgICAgICMgYW5kIGNmZy5nZXRfcXRlbnNvcigpIGlzIE5vbmUKICAgICAgbXNnID0gJ0FRVCBpcyBub3QgeWV0IG9wdGltaXplZCB0byBhY2NlcHQgcXVhbnRpemVkIHR5cGVzIGRpcmVjdGx5LiAnCiAgICAgIG1zZyArPSBmJ2xocy5kdHlwZToge2xocy5kdHlwZX0sIHJocy5kdHlwZToge3Jocy5kdHlwZX0nCiAgICAgIGFzc2VydCBsaHMuZHR5cGUgaW4gW2pucC5iZmxvYXQxNiwgam5wLmZsb2F0MzIsIGpucC5mbG9hdDE2XSwgbXNnCiAgICAgIGFzc2VydCByaHMuZHR5cGUgaW4gW2pucC5iZmxvYXQxNiwgam5wLmZsb2F0MzIsIGpucC5mbG9hdDE2XSwgbXNnCiAgICAgIGNmZy5hc3NlcnRfY29uZmlnX3ZhbGlkaXR5KCkKICAgICAgIyBHZXR0ZXIKICAgICAgbGhzX2FwcGx5X3F1YW50X21vZGUgPSBzZWxmLmxoc19hcHBseV9xdWFudF9tb2RlCiAgICAgIHJoc19hcHBseV9xdWFudF9tb2RlID0gc2VsZi5yaHNfYXBwbHlfcXVhbnRfbW9kZQogICAgICBsaHNfcXQgPSBsaHNfZnJlZXplci5nZXQoKSBpZiBsaHNfYXBwbHlfcXVhbnRfbW9kZSBlbHNlIHNlbGYubGhzX3F0ZW5zb3IKICAgICAgcmhzX3F0ID0gcmhzX2ZyZWV6ZXIuZ2V0KCkgaWYgcmhzX2FwcGx5X3F1YW50X21vZGUgZWxzZSBzZWxmLnJoc19xdGVuc29yCiAgICAgIGNmZy5hcHBseV9jdXN0b21fdmpwX29uX2pheCA9IEZhbHNlCiAgICAgIGFxdF9jb252ID0gYXF0X2NvbnZfZ2VuZXJhbC5tYWtlX2NvbnZfZ2VuZXJhbF9kaWxhdGVkX3dpdGhfcXQoY2ZnLmZ3ZCkKICAgICAgb3V0LCAob3V0X2xoc19xdCwgb3V0X3Joc19xdCkgPSBhcXRfY29udigKICAgICAgICAgIGxocywKICAgICAgICAgIHJocywKICAgICAgICAgIHdpbmRvd19zdHJpZGVzLAogICAgICAgICAgcGFkZGluZywKICAgICAgICAgIGxoc19xdCwKICAgICAgICAgIHJoc19xdCwKICAgICAgICAgIGxoc19kaWxhdGlvbiwKICAgICAgICAgIHJoc19kaWxhdGlvbiwKICAgICAgICAgIGRpbWVuc2lvbl9udW1iZXJzLAogICAgICAgICAgZmVhdHVyZV9ncm91cF9jb3VudCwKICAgICAgICAgIGJhdGNoX2dyb3VwX2NvdW50LAogICAgICAgICAgcHJlY2lzaW9uLAogICAgICAgICAgcHJlZmVycmVkX2VsZW1lbnRfdHlwZQogICAgICAgICAgKQogICAgICAjIFJlbW92ZSBxdmFsdWUgb2YgdGhlIGFjdGl2YXRpb24gdG8gbm90IHRvIHN0b3JlIGl0IGluIEZyZWV6ZXIuCiAgICAgIG1hdGNoIHNlbGYubGhzX2ZyZWV6ZV9tb2RlOgogICAgICAgIGNhc2UgRnJlZXplck1vZGUuTk9ORToKICAgICAgICAgIGlmIHNlbGYubGhzX2FwcGx5X3F1YW50X21vZGUgYW5kIHNlbGYubGhzX3F1YW50X21vZGUgaW4gewogICAgICAgICAgICAgIFF1YW50TW9kZS5DT05WRVJULAogICAgICAgICAgICAgIFF1YW50TW9kZS5TRVJWRSwKICAgICAgICAgIH06CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ0ZyZWV6ZXIgaXMgdXNlZCB3aXRoIEZyZWV6ZXIgbW9kZSBOT05FLicpCiAgICAgICAgY2FzZSBGcmVlemVyTW9kZS5DQUxJQlJBVElPTjoKICAgICAgICAgIG91dF9saHNfcXQgPSBvdXRfbGhzX3F0LndpdGhvdXRfcXZhbHVlKCkKICAgICAgICBjYXNlIEZyZWV6ZXJNb2RlLkNBTElCUkFUSU9OX0FORF9WQUxVRToKICAgICAgICAgIHBhc3MKICAgICAgICBjYXNlIF86CiAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdVbmtub3duIGZyZWV6ZSBtb2RlOiAlcycgJSBzZWxmLmxoc19mcmVlemVfbW9kZSkKICAgICAgbWF0Y2ggc2VsZi5yaHNfZnJlZXplX21vZGU6CiAgICAgICAgY2FzZSBGcmVlemVyTW9kZS5OT05FOgogICAgICAgICAgaWYgc2VsZi5yaHNfYXBwbHlfcXVhbnRfbW9kZSBhbmQgc2VsZi5yaHNfcXVhbnRfbW9kZSBpbiB7CiAgICAgICAgICAgICAgUXVhbnRNb2RlLkNPTlZFUlQsCiAgICAgICAgICAgICAgUXVhbnRNb2RlLlNFUlZFLAogICAgICAgICAgfToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignRnJlZXplciBpcyB1c2VkIHdpdGggRnJlZXplciBtb2RlIE5PTkUuJykKICAgICAgICBjYXNlIEZyZWV6ZXJNb2RlLkNBTElCUkFUSU9OOgogICAgICAgICAgb3V0X3Joc19xdCA9IG91dF9yaHNfcXQud2l0aG91dF9xdmFsdWUoKQogICAgICAgIGNhc2UgRnJlZXplck1vZGUuQ0FMSUJSQVRJT05fQU5EX1ZBTFVFOgogICAgICAgICAgcGFzcwogICAgICAgIGNhc2UgXzoKICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ1Vua25vd24gZnJlZXplIG1vZGU6ICVzJyAlIHNlbGYucmhzX2ZyZWV6ZV9tb2RlKQogICAgICBpZiBzZWxmLmxoc19hcHBseV9xdWFudF9tb2RlOgogICAgICAgIGxoc19mcmVlemVyLnNldChvdXRfbGhzX3F0KQogICAgICBpZiBzZWxmLnJoc19hcHBseV9xdWFudF9tb2RlOgogICAgICAgIHJoc19mcmVlemVyLnNldChvdXRfcmhzX3F0KQogICAgICByZXR1cm4gb3V0CiAgICByZXR1cm4gcmV0X2NnCiAgQG5uLmNvbXBhY3QKICBkZWYgX19jYWxsX18oCiAgICAgIHNlbGYsCiAgICAgIGxocywKICAgICAgcmhzLAogICAgICB3aW5kb3dfc3RyaWRlczogU2VxdWVuY2VbaW50XSwKICAgICAgcGFkZGluZzogc3RyIHwgU2VxdWVuY2VbdHVwbGVbaW50LCBpbnRdXSwKICAgICAgbGhzX2RpbGF0aW9uOiBOb25lIHwgU2VxdWVuY2VbaW50XSA9IE5vbmUsCiAgICAgIHJoc19kaWxhdGlvbjogTm9uZSB8IFNlcXVlbmNlW2ludF0gPSBOb25lLAogICAgICBkaW1lbnNpb25fbnVtYmVyczogKAogICAgICAgICAgTm9uZQogICAgICAgICAgfCBqYXgubGF4LkNvbnZHZW5lcmFsRGlsYXRlZERpbWVuc2lvbk51bWJlcnMKICAgICAgICAgIHwgdHVwbGVbc3RyLCBzdHIsIHN0cl0KICAgICAgKSA9IE5vbmUsCiAgICAgIGZlYXR1cmVfZ3JvdXBfY291bnQ6IGludCA9IDEsCiAgICAgIGJhdGNoX2dyb3VwX2NvdW50OiBpbnQgPSAxLAogICAgICBwcmVjaXNpb246IGpheC5sYXguUHJlY2lzaW9uTGlrZSA9IE5vbmUsCiAgICAgIHByZWZlcnJlZF9lbGVtZW50X3R5cGU9Tm9uZSwKICApOgogICAgcmV0dXJuIHNlbGYubWFrZV9hcXRfY2coKSgKICAgICAgICBsaHMsCiAgICAgICAgcmhzLAogICAgICAgIHdpbmRvd19zdHJpZGVzLAogICAgICAgIHBhZGRpbmcsCiAgICAgICAgbGhzX2RpbGF0aW9uLAogICAgICAgIHJoc19kaWxhdGlvbiwKICAgICAgICBkaW1lbnNpb25fbnVtYmVycywKICAgICAgICBmZWF0dXJlX2dyb3VwX2NvdW50LAogICAgICAgIGJhdGNoX2dyb3VwX2NvdW50LAogICAgICAgIHByZWNpc2lvbiwKICAgICAgICBwcmVmZXJyZWRfZWxlbWVudF90eXBlLAogICAgKQo=' | base64 -d > /usr/local/lib/python3.12/dist-packages/aqt/jax/v2/flax/aqt_flax.py",
      'XLA_FLAGS="--xla_gpu_enable_latency_hiding_scheduler=true --xla_gpu_enable_command_buffer=FUSION --xla_disable_hlo_passes=rematerialization"',
      "export TF_FORCE_GPU_ALLOW_GROWTH=true",
      f"export BASE_OUTPUT_DIRECTORY={local_output_dir}",
      "export ASYNC_CHECKPOINTING=false",
      "export XLA_PYTHON_CLIENT_MEM_FRACTION=0.94",
      "export PER_DEVICE_BATCH_SIZE=190",
      "export PYTHONPATH='/opt/maxtext:${PYTHONPATH:+:$PYTHONPATH}'",
      f"python3 -m MaxText.inference_microbenchmark MaxText/configs/base.yml  base_output_directory=$BASE_OUTPUT_DIRECTORY model_name='llama2-70b' max_prefill_predict_length=1024 max_target_length=2048 attention=dot_product scan_layers=false hardware=gpu async_checkpointing=$ASYNC_CHECKPOINTING per_device_batch_size=$PER_DEVICE_BATCH_SIZE inference_microbenchmark_prefill_lengths=1024 inference_microbenchmark_stages=prefill,generate inference_microbenchmark_loop_iters=64 run_name=$(date +%Y-%m-%d-%H-%M) ici_fsdp_parallelism=1 ici_autoregressive_parallelism=1 ici_tensor_parallelism=-1 weight_dtype=bfloat16 kv_quant_dtype=fp8 quantize_kvcache=True quantization=aqt_fp8 > output.txt",
      "wget https://raw.githubusercontent.com/GoogleCloudPlatform/ml-auto-solutions/refs/heads/master/dags/inference/utils/maxtext_gpu_microbenchmark_jsonl_converter.py",
      f"python maxtext_gpu_microbenchmark_jsonl_converter.py {jsonl_output_path}",
  )
  docker_cmd = " && ".join(docker_cmds)
  run_model_cmds = (
      "pip install jsonlines",
      "gcloud storage cp gs://yijiaj/temp/maxtext_gpu_microbenchmark_jsonl_converter.py .",
      f"docker restart {docker_container_name}",
      f"docker cp maxtext_gpu_microbenchmark_jsonl_converter.py {docker_container_name}:/opt/maxtext/maxtext_gpu_microbenchmark_jsonl_converter.py",
      f"docker exec -i {docker_container_name} /bin/bash -c '{docker_cmd}'",
      f"docker cp {docker_container_name}:{local_output_dir}/{jsonl_output_path} {jsonl_output_path}",
      f"cat {jsonl_output_path}",
      f"gcloud storage cp {jsonl_output_path} {metric_config.SshEnvVars.GCS_OUTPUT.value}",
  )

  job_test_config = test_config.GpuVmTest(
      test_config.Gpu(
          machine_type=machine_type.value,
          image_family=image_family.value,
          count=count,
          accelerator_type=accelerator_type.value,
          runtime_version=RUNTIME_IMAGE,
          network=network,
          subnetwork=subnetwork,
          disk_size_gb=100,
      ),
      test_name=test_name,
      set_up_cmds=set_up_cmds,
      run_model_cmds=run_model_cmds,
      timeout=datetime.timedelta(minutes=time_out_in_min),
      task_owner=test_owner.YIJIA_J,
      gcs_subfolder=f"{GCS_SUBFOLDER_PREFIX}/maxtext_gpu",
      use_existing_instance=existing_instance_name is not None,
  )

  job_gcp_config = gcp_config.GCPConfig(
      project_name=project.value,
      zone=gpu_zone.value,
      dataset_name=metric_config.DatasetOption.BENCHMARK_DATASET,
  )

  job_metric_config = metric_config.MetricConfig(
      json_lines=metric_config.JSONLinesConfig(jsonl_output_path),
      use_runtime_generated_gcs_folder=True,
  )

  return task.GpuCreateResourceTask(
      image_project.value,
      image_family.value,
      job_test_config,
      job_gcp_config,
      job_metric_config,
      existing_instance_name=existing_instance_name,
  )
